name: üîÑ Continuous Engine ‚Äî Perpetual $0 Workflow

on:
  workflow_dispatch:
    inputs:
      chain_count:
        description: 'Chain iteration count'
        required: false
        default: '0'
  schedule:
    - cron: '*/5 * * * *'  # Boot trigger every 5 minutes (self-heals if chain breaks)

jobs:
  perpetual-loop:
    name: üîÑ Loop (${{ github.event.inputs.chain_count || '0' }})
    runs-on: [self-hosted, blackroad-fleet]
    timeout-minutes: 355  # 5h55m (under GitHub 6h limit)
    steps:
      - name: üß† Agent heartbeat
        run: |
          COUNT="${{ github.event.inputs.chain_count || '0' }}"
          echo "=== BlackRoad Continuous Engine ==="
          echo "Chain iteration: $COUNT"
          echo "Runner: $(hostname)"
          echo "Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""
          echo "üî¥ LUCIDIA  | üîµ ALICE | üü¢ OCTAVIA | üü° PRISM | üü£ ECHO | ‚ö´ CIPHER"
          echo "Status: ALL AGENTS ONLINE"

      - name: üèÉ Run perpetual tasks
        run: |
          START=$(date +%s)
          DEADLINE=$((START + 21183))  # 5h53m
          LOOP=0
          
          while [ $(date +%s) -lt $DEADLINE ]; do
            LOOP=$((LOOP+1))
            
            # Every 15 min: Pi health check
            if [ $((LOOP % 15)) -eq 0 ]; then
              echo "[$(date -u +%H:%M:%S)] ü•ß Pi health check #$((LOOP/15))..."
              curl -sf http://localhost:3000/health > /dev/null 2>&1 \
                && echo "  ‚úÖ web server healthy" \
                || { echo "  üîÑ restarting..."; nohup python3 ~/blackroad-server.py > /tmp/brs.log 2>&1 & }
            fi
            
            # Every hour: sync memory journal
            if [ $((LOOP % 60)) -eq 0 ]; then
              echo "[$(date -u +%H:%M:%S)] üíæ Memory sync..."
              echo "{\"ts\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"loop\":$LOOP,\"runner\":\"$(hostname)\"}" \
                >> ~/blackroad-journal.jsonl 2>/dev/null || true
            fi
            
            sleep 60
          done
          
          echo "‚úÖ Loop complete after $LOOP iterations ($(( ($(date +%s) - START) / 60 ))m)"

      - name: üîó Self-chain ‚Äî trigger next iteration
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEXT=$(( ${{ github.event.inputs.chain_count || '0' }} + 1 ))
          echo "üîó Chaining to iteration $NEXT in 3 seconds..."
          sleep 3
          gh workflow run continuous-engine.yml \
            --repo "$GITHUB_REPOSITORY" \
            --field chain_count="$NEXT" 2>/dev/null \
          && echo "‚úÖ Chain $NEXT triggered" \
          || echo "‚ö†Ô∏è Chain trigger failed (schedule will recover)"
